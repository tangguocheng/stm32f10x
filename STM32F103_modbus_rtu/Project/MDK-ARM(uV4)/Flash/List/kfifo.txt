; generated by Component: ARM Compiler 5.05 update 2 (build 169) Tool: ArmCC [4d0f38]
; commandline ArmCC [--list --split_sections --debug -c --asm --interleave -o.\flash\obj\kfifo.o --asm_dir=.\Flash\List\ --list_dir=.\Flash\List\ --depend=.\flash\obj\kfifo.d --cpu=Cortex-M3 --apcs=interwork -O0 --diag_suppress=9931,870 -I..\..\Libraries\CMSIS\Device\ST\STM32F10x\Include -I..\..\Libraries\STM32F10x_StdPeriph_Driver\inc -I..\..\Libraries\STM32_USB-FS-Device_Driver\inc -I..\..\Libraries\CMSIS\Include -I..\..\User\bsp -I..\..\User\bsp\inc -I..\..\User\app\inc -I..\..\User\fonts -I..\..\User\images -I..\..\User\uIP\uip -I..\..\User\uIP\http -I..\..\User\uIP\dm9000 -I..\..\User\FatFS\src -I..\..\User\usb_mass -I..\..\User\CH376\inc -I..\..\User\FreeRTOS\Source\include -I..\..\User\FreeRTOS\Source\portable\MemMang -I..\..\User\FreeRTOS\Source\portable\RVDS\ARM_CM3 -I..\..\User\FreeModbus-V1.5\include -I..\..\User\FreeModbus-V1.5\STM32F103-PORT -I..\..\User\FreeModbus-V1.5\BARE\port -I..\..\User\FreeModbus-V1.5\rtu -I"E:\woosiyuan\smarthome\stm32f10x\STM32F103ZET6+FreeRTOS V8.2.3+kfifo£¨ÇÉ¶áÌì¹¤£©+FreeModbus-V1.5.0-´Ó»ú\Project\MDK-ARM(uV4)\RTE" -IC:\Keil_v5\ARM\PACK\ARM\CMSIS\5.0.1\CMSIS\Include -IC:\Keil_v5\ARM\PACK\Keil\STM32F1xx_DFP\2.2.0\Device\Include -D__MICROLIB -D__UVISION_VERSION=515 -D_RTE_ -DSTM32F10X_HD -DUSE_STDPERIPH_DRIVER -DSTM32F10X_HD --omf_browse=.\flash\obj\kfifo.crf ..\..\User\bsp\kfifo.c]
                          THUMB

                          AREA ||i.__kfifo_get||, CODE, READONLY, ALIGN=1

                  __kfifo_get PROC
;;;148      
;;;149    unsigned int __kfifo_get(struct KFIFO *fifo, unsigned char *buffer, unsigned int len)   
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;150    {
000004  4604              MOV      r4,r0
000006  460e              MOV      r6,r1
000008  4615              MOV      r5,r2
;;;151        unsigned int L;   
;;;152      
;;;153        len = min(len, fifo->in - fifo->out);   
00000a  e9d40102          LDRD     r0,r1,[r4,#8]
00000e  1a40              SUBS     r0,r0,r1
000010  42a8              CMP      r0,r5
000012  d901              BLS      |L1.24|
000014  4628              MOV      r0,r5
000016  e002              B        |L1.30|
                  |L1.24|
000018  e9d40102          LDRD     r0,r1,[r4,#8]
00001c  1a40              SUBS     r0,r0,r1
                  |L1.30|
00001e  4605              MOV      r5,r0
;;;154      
;;;155        /*  
;;;156         * Ensure that we sample the fifo->in index -before- we  
;;;157         * start removing bytes from the kfifo.  
;;;158         */   
;;;159      
;;;160        //smp_rmb();    //å¤šå¤„ç†å™¨ å¤„ç†å†…å­˜ çš„ å±éšœï¼ŒSTM32ä¸éœ€è¦è¿™ä¸ª
;;;161      
;;;162        /* first get the data from fifo->out until the end of the buffer */   
;;;163        L = min(len, fifo->size - (fifo->out & (fifo->size - 1)));   
000020  6861              LDR      r1,[r4,#4]
000022  1e49              SUBS     r1,r1,#1
000024  68e0              LDR      r0,[r4,#0xc]
000026  4008              ANDS     r0,r0,r1
000028  6861              LDR      r1,[r4,#4]
00002a  1a08              SUBS     r0,r1,r0
00002c  42a8              CMP      r0,r5
00002e  d901              BLS      |L1.52|
000030  4628              MOV      r0,r5
000032  e005              B        |L1.64|
                  |L1.52|
000034  6861              LDR      r1,[r4,#4]
000036  1e49              SUBS     r1,r1,#1
000038  68e0              LDR      r0,[r4,#0xc]
00003a  4008              ANDS     r0,r0,r1
00003c  6861              LDR      r1,[r4,#4]
00003e  1a08              SUBS     r0,r1,r0
                  |L1.64|
000040  4607              MOV      r7,r0
;;;164        memcpy(buffer, fifo->buffer + (fifo->out & (fifo->size - 1)), L);   
000042  6862              LDR      r2,[r4,#4]
000044  1e52              SUBS     r2,r2,#1
000046  68e0              LDR      r0,[r4,#0xc]
000048  4010              ANDS     r0,r0,r2
00004a  6822              LDR      r2,[r4,#0]
00004c  1881              ADDS     r1,r0,r2
00004e  463a              MOV      r2,r7
000050  4630              MOV      r0,r6
000052  f7fffffe          BL       __aeabi_memcpy
;;;165      
;;;166        /* then get the rest (if any) from the beginning of the buffer */   
;;;167        memcpy(buffer + L, fifo->buffer, len - L);   
000056  1bea              SUBS     r2,r5,r7
000058  19f0              ADDS     r0,r6,r7
00005a  6821              LDR      r1,[r4,#0]
00005c  f7fffffe          BL       __aeabi_memcpy
;;;168      
;;;169        /*  
;;;170         * Ensure that we remove the bytes from the kfifo -before-  
;;;171         * we update the fifo->out index.  
;;;172         */   
;;;173      
;;;174        //smp_mb();   //å¤šå¤„ç†å™¨ å¤„ç†å†…å­˜ çš„ å±éšœï¼ŒSTM32ä¸éœ€è¦è¿™ä¸ª
;;;175    			
;;;176    			/*
;;;177    		   * æ³¨æ„è¿™é‡Œ åªæ˜¯ç”¨äº† fifo->out +=  len ä¹Ÿæœªå–æ¨¡è¿ç®—ï¼Œ
;;;178    			 * åŒæ ·unsigned intçš„æº¢å‡ºæ€§è´¨ï¼Œå½“out æŒç»­å¢åŠ åˆ°æº¢å‡ºæ—¶åˆä¼šè¢«ç½®ä¸º0ï¼Œ
;;;179    			 * å¦‚æœinå…ˆæº¢å‡ºï¼Œå‡ºç° in  < out çš„æƒ…å†µï¼Œé‚£ä¹ˆ in â€“ out ä¸ºè´Ÿæ•°ï¼ˆåˆå°†æº¢å‡ºï¼‰ï¼Œ
;;;180    			 * in â€“ out çš„å€¼è¿˜æ˜¯ä¸ºbufferä¸­æ•°æ®çš„é•¿åº¦ã€‚
;;;181    			 */
;;;182    
;;;183        fifo->out += len;
000060  68e0              LDR      r0,[r4,#0xc]
000062  4428              ADD      r0,r0,r5
000064  60e0              STR      r0,[r4,#0xc]
;;;184      
;;;185        return len;  
000066  4628              MOV      r0,r5
;;;186    }
000068  e8bd81f0          POP      {r4-r8,pc}
;;;187    
                          ENDP


                          AREA ||i.__kfifo_put||, CODE, READONLY, ALIGN=1

                  __kfifo_put PROC
;;;96     
;;;97     unsigned int __kfifo_put(struct KFIFO *fifo, unsigned char *buffer, unsigned int len)   
000000  e92d41f0          PUSH     {r4-r8,lr}
;;;98     {
000004  4604              MOV      r4,r0
000006  460f              MOV      r7,r1
000008  4615              MOV      r5,r2
;;;99         unsigned int L;
;;;100    	
;;;101    		//ç¯å½¢ç¼“å†²åŒºçš„å‰©ä½™å®¹é‡ä¸ºfifo->size - fifo->in + fifo->outï¼Œè®©å†™å…¥çš„é•¿åº¦å–lenå’Œå‰©ä½™å®¹é‡ä¸­è¾ƒå°çš„ï¼Œé¿å…å†™è¶Šç•Œï¼›
;;;102        len = min( len , fifo->size - fifo->in + fifo->out );
00000a  e9d40101          LDRD     r0,r1,[r4,#4]
00000e  1a40              SUBS     r0,r0,r1
000010  68e1              LDR      r1,[r4,#0xc]
000012  4408              ADD      r0,r0,r1
000014  42a8              CMP      r0,r5
000016  d901              BLS      |L2.28|
000018  4628              MOV      r0,r5
00001a  e004              B        |L2.38|
                  |L2.28|
00001c  e9d40101          LDRD     r0,r1,[r4,#4]
000020  1a40              SUBS     r0,r0,r1
000022  68e1              LDR      r1,[r4,#0xc]
000024  4408              ADD      r0,r0,r1
                  |L2.38|
000026  4605              MOV      r5,r0
;;;103      
;;;104        /*  
;;;105         * Ensure that we sample the fifo->out index -before- we  
;;;106         * start putting bytes into the kfifo.  
;;;107         */   
;;;108    				//å¤šå¤„ç†å™¨ å¤„ç†å†…å­˜ çš„ å±éšœï¼ŒSTM32ä¸éœ€è¦è¿™ä¸ª
;;;109    				//    smp_mb(); 
;;;110      
;;;111        /* first put the data starting from fifo->in to buffer end */
;;;112    				/* é¦–å…ˆå°†æ•°æ®ä»fifo.in æ‰€åœ¨çš„ä½ç½®å¼€å§‹å†™ï¼Œå†™ä¹‹å‰ï¼Œé¦–å…ˆè¦çœ‹ä¸€ä¸‹fifo->inåˆ° buffer æœ«å°¾çš„å¤§å° æ˜¯ä¸æ˜¯ æ¯” len å¤§*/
;;;113    	
;;;114    				/*
;;;115    				 * å‰é¢è®²åˆ°fifo->sizeå·²ç»2çš„æ¬¡å¹‚åœ†æ•´ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿è¿™é‡Œè®¡ç®—ï¼Œæå‡æ•ˆç‡
;;;116    		     * åœ¨å¯¹10è¿›è¡Œæ±‚ä½™çš„æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°ï¼Œä½™æ•°æ€»æ˜¯æ•´æ•°ä¸­çš„ä¸ªä½ä¸Šçš„æ•°å­—ï¼Œè€Œä¸ç”¨ç®¡å…¶ä»–ä½æ˜¯ä»€ä¹ˆï¼›
;;;117    				 * æ‰€ä»¥,kfifo->in % kfifo->size å¯ä»¥è½¬åŒ–ä¸º kfifo->in & (kfifo->size â€“ 1)ï¼Œæ•ˆç‡ä¼šæå‡
;;;118    				 * æ‰€ä»¥fifo->size - (fifo->in & (fifo->size - L)) å³ä½ fifo->in åˆ° bufferæœ«å°¾æ‰€å‰©ä½™çš„é•¿åº¦ï¼Œ
;;;119    				 * Lå–lenå’Œå‰©ä½™é•¿åº¦çš„æœ€å°å€¼ï¼Œå³ä¸ºéœ€è¦æ‹·è´L å­—èŠ‚åˆ°fifo->buffer + fifo->inçš„ä½ç½®ä¸Šã€‚
;;;120    				 */ 
;;;121        L = min(len, fifo->size - (fifo->in & (fifo->size - 1)));
000028  e9d41001          LDRD     r1,r0,[r4,#4]
00002c  1e49              SUBS     r1,r1,#1
00002e  4008              ANDS     r0,r0,r1
000030  6861              LDR      r1,[r4,#4]
000032  1a08              SUBS     r0,r1,r0
000034  42a8              CMP      r0,r5
000036  d901              BLS      |L2.60|
000038  4628              MOV      r0,r5
00003a  e005              B        |L2.72|
                  |L2.60|
00003c  e9d41001          LDRD     r1,r0,[r4,#4]
000040  1e49              SUBS     r1,r1,#1
000042  4008              ANDS     r0,r0,r1
000044  6861              LDR      r1,[r4,#4]
000046  1a08              SUBS     r0,r1,r0
                  |L2.72|
000048  4606              MOV      r6,r0
;;;122    	
;;;123        memcpy(fifo->buffer + (fifo->in & (fifo->size - 1)), buffer, L);
00004a  e9d42101          LDRD     r2,r1,[r4,#4]
00004e  1e52              SUBS     r2,r2,#1
000050  4011              ANDS     r1,r1,r2
000052  6822              LDR      r2,[r4,#0]
000054  1888              ADDS     r0,r1,r2
000056  4632              MOV      r2,r6
000058  4639              MOV      r1,r7
00005a  f7fffffe          BL       __aeabi_memcpy
;;;124      
;;;125        /* then put the rest (if any) at the beginning of the buffer */ 
;;;126    
;;;127        memcpy(fifo->buffer, buffer + L, len - L);
00005e  1baa              SUBS     r2,r5,r6
000060  19b9              ADDS     r1,r7,r6
000062  6820              LDR      r0,[r4,#0]
000064  f7fffffe          BL       __aeabi_memcpy
;;;128      
;;;129        /*  
;;;130         * Ensure that we add the bytes to the kfifo -before-  
;;;131         * we update the fifo->in index.  
;;;132         */   
;;;133      
;;;134          // smp_wmb();   //å¤šå¤„ç†å™¨ å¤„ç†å†…å­˜ çš„ å±éšœï¼ŒSTM32ä¸éœ€è¦è¿™ä¸ª	
;;;135    
;;;136    			/* 
;;;137    			 * æ³¨æ„è¿™é‡Œ åªæ˜¯ç”¨äº† fifo->in +=  lenè€Œæœªå–æ¨¡ï¼Œ
;;;138    			 * è¿™å°±æ˜¯kfifoçš„è®¾è®¡ç²¾å¦™ä¹‹å¤„ï¼Œè¿™é‡Œç”¨åˆ°äº†unsigned intçš„æº¢å‡ºæ€§è´¨ï¼Œ
;;;139    			 * å½“in æŒç»­å¢åŠ åˆ°æº¢å‡ºæ—¶åˆä¼šè¢«ç½®ä¸º0ï¼Œè¿™æ ·å°±èŠ‚çœäº†æ¯æ¬¡inå‘å‰å¢åŠ éƒ½è¦å–æ¨¡çš„æ€§èƒ½ï¼Œ
;;;140    			 * é”±é“¢å¿…è¾ƒï¼Œç²¾ç›Šæ±‚ç²¾ï¼Œè®©äººä¸å¾—ä¸ä½©æœã€‚
;;;141    			 */
;;;142      
;;;143        fifo->in += len; 
000068  68a0              LDR      r0,[r4,#8]
00006a  4428              ADD      r0,r0,r5
00006c  60a0              STR      r0,[r4,#8]
;;;144    		
;;;145      	/*è¿”å›å€¼ ä»£è¡¨  å†™å…¥æ•°æ®çš„ä¸ªæ•° ï¼Œè¿™æ · å°±å¯ä»¥æ ¹æ®è¿”å›å€¼ åˆ¤æ–­ç¼“å†²åŒºæ˜¯å¦å†™æ»¡*/
;;;146        return len;
00006e  4628              MOV      r0,r5
;;;147    }  
000070  e8bd81f0          POP      {r4-r8,pc}
;;;148      
                          ENDP


                          AREA ||i.kfifo_alloc||, CODE, READONLY, ALIGN=1

                  kfifo_alloc PROC
;;;53     
;;;54     struct KFIFO *kfifo_alloc(unsigned int size) 
000000  b570              PUSH     {r4-r6,lr}
;;;55     {   
000002  4605              MOV      r5,r0
;;;56         unsigned char *buffer;
;;;57     	
;;;58         struct KFIFO *ret;
;;;59     	
;;;60     		ret=(struct KFIFO *) pvPortMalloc(sizeof (struct KFIFO));
000004  2010              MOVS     r0,#0x10
000006  f7fffffe          BL       pvPortMalloc
00000a  4604              MOV      r4,r0
;;;61     
;;;62         /*  
;;;63          * round up to the next power of 2, since our 'let the indices  
;;;64          * wrap' tachnique works only in this case.  
;;;65     		 * å¦‚æœsize æ˜¯2çš„ æ¬¡å¹‚åœ†æ•´ï¼Œåˆ™ size & (size - 1)  =0
;;;66          */
;;;67       
;;;68         if (size & (size - 1)) 
00000c  1e68              SUBS     r0,r5,#1
00000e  4028              ANDS     r0,r0,r5
000010  b118              CBZ      r0,|L3.26|
;;;69     		{   
;;;70     			//        BUG_ON(size > 0x80000000);  
;;;71     			
;;;72     			//å¦‚æœä½ è¦ç”³è¯·çš„buffer ä¸æ˜¯ 2çš„ æ¬¡å¹‚åœ†æ•´ï¼Œå°±è¦æŠŠ size å˜æˆ 2çš„æ¬¡å¹‚åœ†æ•´ ï¼Œæ–¹ä¾¿ä¸‹é¢è®¡ç®—
;;;73             size = roundup_pow_of_two(size);
000012  4628              MOV      r0,r5
000014  f7fffffe          BL       roundup_pow_of_two
000018  4605              MOV      r5,r0
                  |L3.26|
;;;74         }
;;;75     		
;;;76     		//è¿™é‡Œä½¿ç”¨ FreeRTOSçš„ åˆ†é…å†…å­˜çš„ API
;;;77         buffer = (unsigned char*) pvPortMalloc(size);
00001a  4628              MOV      r0,r5
00001c  f7fffffe          BL       pvPortMalloc
000020  4606              MOV      r6,r0
;;;78     		
;;;79         if (!buffer)   //å¦‚æœè¿”å›çš„å€¼ä¸ºNULLï¼Œè¿™è¯´æ˜åˆ†é…å†…å­˜å¤±è´¥
000022  b90e              CBNZ     r6,|L3.40|
;;;80             return 0UL;
000024  2000              MOVS     r0,#0
                  |L3.38|
;;;81       
;;;82     		//    ret = kfifo_init(buffer, size, lock);   
;;;83     		
;;;84     		ret->buffer=buffer;
;;;85     		ret->size  =size;
;;;86     		ret->in  = 0;
;;;87     		ret->out = 0;
;;;88     		
;;;89         if (!ret) //å¦‚æœretçš„å€¼ä¸ºNULLï¼Œè¿™è¯´æ˜åˆ†é…å†…å­˜å¤±è´¥
;;;90             vPortFree(buffer); //é‡Šæ”¾ä¹‹å‰åˆ†é…çš„ å†…å­˜ç©ºé—´
;;;91       
;;;92         return ret;
;;;93     		
;;;94     }
000026  bd70              POP      {r4-r6,pc}
                  |L3.40|
000028  6026              STR      r6,[r4,#0]            ;84
00002a  6065              STR      r5,[r4,#4]            ;85
00002c  2000              MOVS     r0,#0                 ;86
00002e  60a0              STR      r0,[r4,#8]            ;86
000030  60e0              STR      r0,[r4,#0xc]          ;87
000032  b914              CBNZ     r4,|L3.58|
000034  4630              MOV      r0,r6                 ;90
000036  f7fffffe          BL       vPortFree
                  |L3.58|
00003a  4620              MOV      r0,r4                 ;92
00003c  e7f3              B        |L3.38|
;;;95     
                          ENDP


                          AREA ||i.roundup_pow_of_two||, CODE, READONLY, ALIGN=1

                  roundup_pow_of_two PROC
;;;32     //æ‰¾å‡ºæœ€æ¥è¿‘ æœ€å¤§2çš„æŒ‡æ•°æ¬¡å¹‚
;;;33     unsigned int roundup_pow_of_two(unsigned int date_roundup_pow_of_two )
000000  4601              MOV      r1,r0
;;;34     {			
;;;35     	/* è¿™é‡Œé‡‡ç”¨ STM32 ç¡¬ä»¶æä¾›çš„è®¡ç®—å‰å¯¼é›¶æŒ‡ä»¤ CLZ
;;;36     	 * ä¸¾ä¸ªä¾‹å­ï¼Œå‡å¦‚å˜é‡date_roundup_pow_of_two 0x09
;;;37     	 *ï¼ˆäºŒè¿›åˆ¶ä¸ºï¼š0000 0000 0000 0000 0000 0000 0000 1001ï¼‰, å³bit3å’Œbit0ä¸º1
;;;38     	 * åˆ™__clz( (date_roundup_pow_of_two)çš„å€¼ä¸º28,å³æœ€é«˜ä½1 å‰é¢æœ‰28ä¸ª0,32-28 =3 ä»£è¡¨æœ€é«˜ä½1 çš„ ä½ç½®
;;;39     	 * 31UL è¡¨ç¤º æ— ç¬¦å· int æ•°å­— 31ï¼Œå¦åˆ™é»˜è®¤ä¸º æœ‰ç¬¦å· int æ•°å­— 31
;;;40     	 * è¿™é‡Œå‚è€ƒ  FreeRTOS çš„ å¯»æ‰¾é«˜çº§ä¼˜å…ˆçº§ä»»åŠ¡ çš„å†™æ³•ï¼Œè¯¦ç»†è§£é‡Šåˆ°æœ±å·¥åšå®¢
;;;41     	 * åšå®¢åœ°å€: http://blog.csdn.net/zhzht19861011/article/details/51418383
;;;42     	 */
;;;43     
;;;44     	return ( 1UL << ( 32UL - ( unsigned int ) __clz( (date_roundup_pow_of_two) ) ) );
000002  fab1f081          CLZ      r0,r1
000006  f1c00220          RSB      r2,r0,#0x20
00000a  2001              MOVS     r0,#1
00000c  4090              LSLS     r0,r0,r2
;;;45     
;;;46     }
00000e  4770              BX       lr
;;;47     
                          ENDP


;*** Start embedded assembler ***

#line 1 "..\\..\\User\\bsp\\kfifo.c"
	AREA ||.rev16_text||, CODE
	THUMB
	EXPORT |__asm___7_kfifo_c_7dbab9af____REV16|
#line 114 "..\\..\\Libraries\\CMSIS\\Include\\core_cmInstr.h"
|__asm___7_kfifo_c_7dbab9af____REV16| PROC
#line 115

 rev16 r0, r0
 bx lr
	ENDP
	AREA ||.revsh_text||, CODE
	THUMB
	EXPORT |__asm___7_kfifo_c_7dbab9af____REVSH|
#line 128
|__asm___7_kfifo_c_7dbab9af____REVSH| PROC
#line 129

 revsh r0, r0
 bx lr
	ENDP

;*** End   embedded assembler ***
